<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Surf</title>
</head>
<style>
  * {
    margin: 0px;
    padding: 0px;
  }

  nav {
    position: top;
    top: 0px;
    -webkit-app-region: drag;
  }

  .title {
    width: 100%;
    height: 30px;
    /* margin-bottom: 20px; */
    background-color: #35383d;
    display: flex;
    align-items: center;
    flex-direction: row;
    padding: 3px;
    /* justify-content: space-between; */
  }

  .search {
    /* -webkit-app-region: no-drag; */
    margin-left: 20%;
    width: 100%;
    margin-right: 80px;
    display: flex;
    
  }

  .search input {
    width: 100%;
    -webkit-app-region: no-drag;
height: auto;
margin-right: 5px;
  }

  .search img {
    -webkit-app-region: no-drag;

    margin-left: 5px;
  }

  .buttons {
    -webkit-app-region: no-drag;
    width: auto;
    align-self: auto;
    margin-right: 5px;
    display: flex;
    flex-direction: row;
  }

  .window-control {
    transition: 10ms;
  }

  .window-control:hover {
    opacity: 0.5;
    
    
  }

  .tabs-selector {
    position: fixed;
    top: 30px;
    display: flex;
    background-color: #35383d;
    justify-content: space-between;
    width: 100%;
    height: 24px;
  }

  .tabs-selector div{
    width: 100%;
    height: 24px;
    background-color: #4c4f55;
    display: flex;
    justify-content: space-between;
    border: 1px solid black;
    padding-left: 10px;
    padding-right: 5px;
    padding-bottom: 5px;
    align-items: center;
  }

  .tabs-selector div p {
    margin-right: 5px;
    align-self: flex-start;
    color: white;
    font-family: Verdana, Geneva, Tahoma, sans-serif;
  }

  .tabs-selector div img {
    margin-left: 5px;
    margin-bottom: 8px;
    align-self: flex-end;
  }

  .tabs {
    display: inline;

  } 

  .noselect {
    user-select: none;
  }

 

  
</style>

<body>


  <nav class="title">

    <div class="search">


        <input type="text" name="" id="url_bar" placeholder="">

      
      <img onclick="newTab()" width="20px" height="20px" src="./icons8-plus-24.png" alt="" srcset="">
    </div>

    <div class="buttons">
      <span> <img class='window-control' onclick="max()" height="16px" width="16px"
          src="./icons8-macos-full-screen-30.png" alt="" srcset=""> </span>
      <span> <img class='window-control' onclick="min()" height="16px" width="16px" src="./icons8-macos-minimize-30.png"
          alt="" srcset=""> </span>
      <span> <img class='window-control' onclick="cl()" height="16px" width="16px" src="./icons8-macos-close-30.png"
          alt="" srcset=""> </span>
    </div>


    
  </nav>

  <div class="bar">
    <div id="selector" class="tabs-selector">
    
    </div>
    
  </div>
  



  <div id="tabs" class="tabs">
  </div>



</body>

<script src="https://requirejs.org/docs/release/2.3.5/minified/require.js"></script>
<script src="./script.js"></script>

<script>

  const getWindow = () => remote.BrowserWindow.getFocusedWindow();

  const max = () => {
    const window = getWindow();
    window.isMaximized() ? window.unmaximize() : window.maximize();
  }
  const min = () => {
    getWindow().minimize();
  }
  const cl = () => {
    getWindow().close();
  }

  
  
</script>

<script>
  const newTab = () => {
    // console.log('aaaaa');
    createTabs('https://www.google.com', processTabs);
  }
</script>

<script>
  
  const createTabs = (url, callback) => {
    const tabs = id('tabs');
    const selector = id('selector');
    tabs.innerHTML += `<webview id='tabs_${TAB_COUNT}' src="${url}" style="display: inline-flex !important; position: fixed; top: 54px;width: 100%;height: 100%;"></webview>
`;
selector.innerHTML += `<div onclick='surfaceTab(${TAB_COUNT})' class='indi_tab' id='selector_${TAB_COUNT}'><p class='noselect'></p><img height='10px' width='10px' onclick='closeTab(${TAB_COUNT})' src='./close.png'></div>`;

TAB_COUNT++;

callback(TAB_COUNT-1);


  }

  const processTabs = (number) => {
    const this_tab = id(`tabs_${number}`);
const this_selector = id(`selector_${number}`);
console.log(this_tab);
this_tab.addEventListener('did-stop-loading', () => {
let title = "";
  setTimeout(() => {
     title = this_tab.getTitle();
     console.log(title);
  this_selector.firstElementChild.innerHTML = title;
  if(!MASTER_RECORD.includes(number)) {
    MASTER_RECORD.push(number);

  }
  }, 2000);
  makeSearchBarCorrect(number);
});

  }

  const closeTab = (number) => {
    console.log(number);
    const this_tab = id(`tabs_${number}`);
const this_selector = id(`selector_${number}`);
this_tab.remove();
this_selector.remove();
const index = MASTER_RECORD.indexOf(number);
if (index > -1) {
  MASTER_RECORD.splice(index, 1);
}

surfaceTab(MASTER_RECORD[0]);

  }

  const surfaceTab = (number) => {
    let idwillbe = `tabs_${number}`
    const current_tabs = id('tabs').childNodes;
    current_tabs.forEach(element => {
      // console.log(element.id, element.id != idwillbe);
      if (element.tagName === 'WEBVIEW' && element.id != idwillbe) {
        element.style = 'display: inline-flex !important;flex: 0 1; position: fixed; top: 54px;height: 0px !important; width: 0px !important';
        // element.style.width = '0px !important';
        // console.log('here', element);
      } else if(element.tagName === 'WEBVIEW') {
        element.style = 'display: inline-flex !important; position: fixed; top: 54px;height: 100% !important; width: 100% !important';
      }
    });
    makeSearchBarCorrect(number);
  }

  const makeSearchBarCorrect = (number) => {
    console.log(number);
    let curr_tab_src = id(`tabs_${number}`).src;
    id('url_bar').value = curr_tab_src;
  }

  createTabs('https://google.com', processTabs);


</script>

<script>
  const input = id('url_bar');
  input.addEventListener("keyup", function(event) {
    if (event.keyCode === 13) {
      event.preventDefault();
      url_process(input.value);
  }
});

//from sov
function isUrlValid(userInput) {
    var res = userInput.match(/(http(s)?:\/\/.)?(www\.)?[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)/g);
    if(res == null)
        return false;
    else
        return true;
}


const url_process = (url) => {
if(isUrlValid(url)) {
  createTabs(url, processTabs);
}else {
  createTabs(`https://www.google.com/search?q=${url}`, processTabs);
}
}
</script>

<script>
  function send_data(data) {
    ipcRenderer.send('test', data)
  }

  ipcRenderer.on('test', (e, args) => {
    console.log('got it!');
  })

  // send_data("ahhaa");


</script>

</html>